<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Messages - Apple Money</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #121212; color: #fff; }
    .card-bg { background-color: #1e1e1e; }
    .text-accent { color: #ff8c00; }
    .online-dot { width: 10px; height: 10px; border-radius: 50%; background-color: #22c55e; }
    .offline-dot { width: 10px; height: 10px; border-radius: 50%; background-color: #6b7280; }
  </style>
</head>
<body class="max-w-md mx-auto">

  <header class="p-4 flex items-center justify-between card-bg sticky top-0">
    <h1 class="text-xl font-bold text-accent">ðŸ’¬ Messages</h1>
    <button onclick="window.location.href='index.html'" class="text-gray-400 hover:text-white">
      <i data-lucide="arrow-left"></i>
    </button>
  </header>

  <main class="p-4">
    <div id="user-list" class="space-y-3"></div>

    <div id="chat-box" class="hidden flex flex-col h-[70vh]">
      <div id="chat-header" class="flex items-center justify-between card-bg p-3 rounded-t-lg">
        <div class="flex items-center space-x-2">
          <span id="chat-status-dot" class="offline-dot"></span>
          <h2 id="chat-username" class="font-semibold"></h2>
        </div>
        <button onclick="closeChat()" class="text-gray-400 hover:text-white">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div id="chat-messages" class="flex-1 overflow-y-auto p-3 bg-black/20"></div>

      <div class="flex items-center p-3 card-bg rounded-b-lg space-x-2">
        <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 p-2 rounded-lg bg-gray-800 border border-gray-700" />
        <button id="send-btn" class="bg-orange-500 text-black px-4 py-2 rounded-lg font-semibold">Send</button>
      </div>
    </div>
  </main>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyDpn-sHHX8CIRYtQZc1KpQ9wnvT7h-uSBA",
      authDomain: "taka-chao-to.firebaseapp.com",
      databaseURL: "https://taka-chao-to-default-rtdb.firebaseio.com",
      projectId: "taka-chao-to",
      storageBucket: "taka-chao-to.firebasestorage.app",
      messagingSenderId: "790884034351",
      appId: "1:790884034351:web:63e38bc5c632f88a5ca3da",
      measurementId: "G-8LQ9MH4FDS"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, query, onSnapshot, addDoc, orderBy, doc, setDoc, updateDoc, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getDatabase, ref, onDisconnect, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    const userListEl = document.getElementById('user-list');
    const chatBox = document.getElementById('chat-box');
    const chatMessagesEl = document.getElementById('chat-messages');
    const chatUsernameEl = document.getElementById('chat-username');
    const chatStatusDot = document.getElementById('chat-status-dot');
    const sendBtn = document.getElementById('send-btn');
    const messageInput = document.getElementById('message-input');

    let currentUser = null;
    let activeChatUser = null;
    let unsubscribeMessages = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      setupPresence(user.uid);
      loadUsers();
    });

    function setupPresence(uid) {
      const statusRef = ref(rtdb, `status/${uid}`);
      set(statusRef, { online: true, lastSeen: Date.now() });
      onDisconnect(statusRef).set({ online: false, lastSeen: Date.now() });
    }

    async function loadUsers() {
      const q = query(collection(db, "users"));
      onSnapshot(q, async (snapshot) => {
        userListEl.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const user = docSnap.data();
          if (user.uid === currentUser.uid) return;
          const userEl = document.createElement('div');
          userEl.className = "flex items-center justify-between card-bg p-3 rounded-lg cursor-pointer hover:bg-gray-800";
          userEl.innerHTML = `
            <div class="flex items-center space-x-3">
              <span id="status-${user.uid}" class="offline-dot"></span>
              <div>
                <p class="font-semibold">${user.name || user.email}</p>
                <p class="text-xs text-gray-400">${user.email}</p>
              </div>
            </div>`;
          userEl.onclick = () => openChat(user);
          userListEl.appendChild(userEl);
          watchPresence(user.uid);
        });
        lucide.createIcons();
      });
    }

    function watchPresence(uid) {
      const statusRef = ref(rtdb, `status/${uid}`);
      onValue(statusRef, (snapshot) => {
        const data = snapshot.val();
        const dot = document.getElementById(`status-${uid}`);
        if (dot && data) dot.className = data.online ? "online-dot" : "offline-dot";
      });
    }

    async function openChat(user) {
      activeChatUser = user;
      userListEl.classList.add("hidden");
      chatBox.classList.remove("hidden");
      chatUsernameEl.textContent = user.name || user.email;
      watchPresence(user.uid);

      if (unsubscribeMessages) unsubscribeMessages();

      const chatId = getChatId(currentUser.uid, user.uid);
      const msgRef = collection(db, "messages", chatId, "chats");
      const q = query(msgRef, orderBy("timestamp"));
      unsubscribeMessages = onSnapshot(q, (snapshot) => {
        chatMessagesEl.innerHTML = "";
        snapshot.forEach((msgDoc) => {
          const msg = msgDoc.data();
          const align = msg.senderId === currentUser.uid ? "justify-end" : "justify-start";
          const color = msg.senderId === currentUser.uid ? "bg-orange-500 text-black" : "bg-gray-700 text-white";
          const el = document.createElement('div');
          el.className = `flex ${align} mb-2`;
          el.innerHTML = `<div class="max-w-[80%] p-2 rounded-lg ${color}">${msg.text}</div>`;
          chatMessagesEl.appendChild(el);
        });
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      });
    }

    function getChatId(uid1, uid2) {
      return [uid1, uid2].sort().join("_");
    }

    sendBtn.addEventListener('click', async () => {
      const text = messageInput.value.trim();
      if (!text || !activeChatUser) return;
      messageInput.value = "";

      const chatId = getChatId(currentUser.uid, activeChatUser.uid);
      const msgRef = collection(db, "messages", chatId, "chats");
      await addDoc(msgRef, {
        senderId: currentUser.uid,
        receiverId: activeChatUser.uid,
        text: text,
        timestamp: serverTimestamp()
      });
    });

    function closeChat() {
      chatBox.classList.add("hidden");
      userListEl.classList.remove("hidden");
      if (unsubscribeMessages) unsubscribeMessages();
    }

    lucide.createIcons();
  </script>
</body>
</html>
